<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Homepage</title>
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/ionicons/2.0.1/css/ionicons.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.14.7/umd/popper.min.js"
        integrity="sha384-UO2eT0CpHqdSJQ6hJty5KVphtPhzWj9WO1clHTMGa3JDZwrnQq4sF86dIHNDz0W1"
        crossorigin="anonymous"></script>
    <script src="https://unpkg.com/axios/dist/axios.min.js"></script>
    <!-- link jquery -->
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.2.1/jquery.min.js"></script>
    <script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/js/bootstrap.min.js"></script>
    <!-- link jquery -->
    <link rel="stylesheet" type="text/css" href="https://cdn.datatables.net/v/dt/dt-1.12.1/datatables.min.css" />
    <script type="text/javascript" src="https://cdn.datatables.net/v/dt/dt-1.12.1/datatables.min.js"></script>

    <link rel="stylesheet" href="src/css/style.css">
</head>

<body>
    <nav>
        <div class="container-fluid navbar navbar-fixed-top">
            <div class="navbar-header">
                <a class="navbar-brand" href="index.html">
                    <img id="brand" alt="Brand" src="images/brand.png" height="30px" width="50px">
                </a>
            </div>
            <ul class="nav navbar-nav">
                <li class="active"><a href="index.html">Home</a></li>
                <li><a href="#">About</a></li>
                <li><a href="#">Contact</a></li>
                <li id="admin-panel"></li>
            </ul>
            <ul class="nav navbar-nav navbar-right" id="nav-right-btn">
                <li><a href="register.html"><span class="glyphicon glyphicon-user"></span> Sign Up</a></li>
                <li><a href="login.html"><span class="glyphicon glyphicon-log-in"></span> Login</a></li>
            </ul>
            <ul class="nav navbar-nav navbar-right" id="nav-right-loggedin">
                <li id="nav-shoppingcart-item"><a href="shoppingcart.html"><span id="shoppingcart-count"></span><span
                            class="glyphicon glyphicon-shopping-cart"></span> Shopping Cart</a></li>
                <li id="nav-username-item"><span id="nav-username"></span></li>
                <li id="nav-logout-btn"><a href="index.html"><span class="glyphicon glyphicon-log-in"></span><button
                            id="logout-btn" class="btn-link">Log Out</button></a></li>
            </ul>
        </div>
    </nav>
    <div class="container-fluid home-page">

    </div>
    <div class="container-fluid home-page-body">
        <div class="book-flight-box">
            <h2>Book Trip</h2>
            <hr class="line-black">
            <div class="booking-menu">
                <h4 id="booking-menu-title">Hi, where would you like to Go?</h4>
                <!-- dropdown box for user to put origin airport and destination airport -->
                <div class="form-from-input">
                    <label> From</label>
                    <select class="form-control" id="origin">
                        <option value="">Select Airport</option>
                    </select>
                </div>
                <div class="form-to-input">
                    <label> To</label>
                    <select class="form-control" id="destination">
                        <option value="">Select Airport</option>
                    </select>
                </div>
                <div class="form-depart-date">
                    <label> Departure Date</label>
                    <input type="date" class="form-control" id="depart-date">
                </div>
                <div class="form-return-date">
                    <label> Return Date</label>
                    <input type="date" class="form-control" id="return-date">
                </div>
                <!-- radio for user to select if they want one way trip or return flights -->
                <div class="form-check-input">
                    <label class="form-check-label">
                        <input type="radio" class="form-radio" name="trip-type" id="one-way" value="one_way" checked>
                        One Way
                        <input type="radio" class="form-radio" name="trip-type" id="return" value="return">
                        Return trip
                    </label>
                </div>
                <div class="form-submit">
                    <button id="form-submit-btn" type="submit" class="btn btn-primary form-search-btn">Search</button>
                </div>
            </div>
            <span id="form-error"></span>
        </div>
        <!-- promotion table to list all promotions on going -->
    </div>
    <div class="container-fluid promotion-table">
        <h2>On Going Promotions</h2>
        <hr class="line-black">
        <!-- use datatable to create a table for listing promotions -->
        <table id="promotion-table" class="display" style="width:100%">
            <thead>
                <tr>
                    <th>#</th>
                    <th>Flight Code</th>
                    <th>Promotion Code</th>
                    <th>Discount Offered</th>
                </tr>
            </thead>
            <tbody id="promotion-table-items"></tbody>
        </table>
    </div>
    <div class="footer-clean">
        <footer>
            <div class="container">
                <div class="row justify-content-center">
                    <div class="col-sm-4 col-md-3 item">
                        <h3>Services</h3>
                        <ul>
                            <li><a href="#">Web design</a></li>
                            <li><a href="#">Development</a></li>
                            <li><a href="#">Hosting</a></li>
                        </ul>
                    </div>
                    <div class="col-sm-4 col-md-3 item">
                        <h3>About</h3>
                        <ul>
                            <li><a href="#">Company</a></li>
                            <li><a href="#">Team</a></li>
                            <li><a href="#">Legacy</a></li>
                        </ul>
                    </div>
                    <div class="col-sm-4 col-md-3 item">
                        <h3>Careers</h3>
                        <ul>
                            <li><a href="#">Job openings</a></li>
                            <li><a href="#">Employee success</a></li>
                            <li><a href="#">Benefits</a></li>
                        </ul>
                    </div>
                    <div class="col-lg-3 item social"><a href="#"><i class="icon ion-social-facebook"></i></a><a
                            href="#"><i class="icon ion-social-twitter"></i></a><a href="#"><i
                                class="icon ion-social-snapchat"></i></a><a href="#"><i
                                class="icon ion-social-instagram"></i></a>
                        <p class="copyright">SP AIR Â© 2022</p>
                    </div>
                </div>
            </div>
        </footer>
    </div>
</body>
<script>
    $(document).ready(function () {
        var token = localStorage.getItem('token');
        var userid = localStorage.getItem('userid');
        if (!token) {
            // user not logged in
            $("#nav-right-loggedin").hide()
        } else {
            // user is logged in
            $.ajax({
                url: "http://localhost:3000/api/user/" + userid,
                type: "GET",
                headers: {
                    "Content-Type": "application/json",
                    "Authorization": "Bearer " + token,
                },
                contentType: "application/json",
                success: function (data) {
                    if (data.role == "admin") {
                        // if user is admin, show admin panel
                        $("#admin-panel").html('<a href="adminpanel.html">Admin panel</a>');
                    }
                    // if user has token, get user info
                    $("#username").html(data.username);
                    $("#nav-username").html('<img id="profile-pic"> ' + '<a href="profile.html">' + data.username + '</a>');
                    // alert(data.profile_pic_url)
                    var profile_pic_url = data.profile_pic_url;
                    // alert(pro)
                    if (profile_pic_url == null) {
                        var profile_pic = "pfp_default.png";
                    } else {
                        var profile_pic = profile_pic_url.split("\\")[2];
                    }
                    // alert(profile_pic);
                    $("#profile-pic").attr("src", "images/" + profile_pic);
                    $("#profile-panel-pic").attr("src", "images/" + profile_pic);
                    $("#email").html('<div>Email: ' + data.email + '</div>');
                    $("#profile_pic_url").html(data.profile_pic_url);
                    $("#created_at").html('<div>Created account at: ' + data.created_at + '</div>');
                    // hide sign up and login buttons
                    $("#nav-right-btn").hide();
                    $.ajax({
                        url: "http://localhost:3000/api/shoppingcart/" + userid,
                        type: "GET",
                        headers: {
                            "Content-Type": "application/json",
                            "Authorization": "Bearer " + token,
                        },
                        contentType: "application/json",
                        success: function (data) {
                            // if user has token, get user info
                            $("#shoppingcart-count").html(data.length);
                        },
                        error: function (data) {
                            $("#shoppingcart-count").html("0");
                        }
                    })
                },
                error: function (data) {
                    // if the token is invalid, redirect to login page
                    window.location.href = "http://localhost:3000/index.html";
                }
            });
        };
        // get all airports
        $.ajax({
            url: "http://localhost:3000/api/airport",
            type: "GET",
            headers: {
                "Content-Type": "application/json",
                "Authorization": "Bearer " + token,
            },
            contentType: "application/json",
            success: function (data) {
                // if user has token, get user info
                var airports = data;
                var airport_list = [];
                for (var i = 0; i < airports.length; i++) {
                    var airport = airports[i];
                    var airport_name = airport.airport_name;
                    var airport_id = airport.airportid;
                    if (airport_name) {
                        $('#origin').append('<option value="' + airport_id + '">' + airport_name + '</option>');
                        $('#destination').append('<option value="' + airport_id + '">' + airport_name + '</option>');
                    }
                }
            },
            error: function (data) {
                // if the token is invalid, redirect to login page
                window.location.href = "http://localhost:3000/index.html/";
            }
        });
        $.ajax(
            {
                url: "http://localhost:3000/api/promotions/promocode",
                type: "GET",
                headers: {
                    "Content-Type": "application/json",
                    "Authorization": "Bearer " + token,
                },
                contentType: "application/json",
                success: function (data) {
                    // if user has token, get user info
                    var promocodes = data;
                    var promocode_list = [];
                    // alert(JSON.stringify(data))
                    for (var i = 0; i < data.length; i++) {
                        var promocode = promocodes[i];
                        var promotionid = promocode.promotionid;
                        var flightcode = promocode.flightCode;
                        var discountoffered = promocode.discountoffered;
                        var promotioncode = promocode.promotioncode;
                        var promocode_item_html = '<tr><td>' + (i+1) + '</td><td>' + flightcode + '</td><td>' + promotioncode + '</td><td>' + discountoffered + '%' + ' </td></tr>';
                        $('#promotion-table-items').append(promocode_item_html);
                    }
                    $('#promotion-table').DataTable({
                        "columnDefs": [{
                            "targets": [0],
                            "visible": true,
                            "searchable": true
                        }]
                    });
                },
            }
        )

        $("#logout-btn").click(() => {
            localStorage.removeItem("token");
            localStorage.removeItem("userid");
            window.location.href = "http://localhost:3000/index.html";
        });

        $("#form-submit-btn").click(() => {
            // get the value from the input
            var originAirport = $("#origin").val();
            var destinationAirport = $("#destination").val();
            var departureDate = $("#depart-date").val();
            var returnDate = $("#return-date").val();
            // replace the - with /
            // get the value of type from the radio
            // alert(originAirport + " " + destinationAirport + " " + departureDate + " " + returnDate);
            var type = $('input[name=trip-type]:checked').val();
            if (!originAirport || !destinationAirport || !departureDate) {
                $("#form-error").html('<div class="alert alert-danger"><strong>Please fill in all fields</strong></div>');
                // $("#form-error").show();
                setTimeout(() => $("#form-error").html(''), 5000);
            } else if (originAirport == destinationAirport) {
                $("#form-error").html('<div class="alert alert-danger"><strong>Origin Airport cannot be the same as Destination Airport</strong></div>');
                // $("#form-error").show();
                setTimeout(() => $("#form-error").html(''), 5000);
            } else {
                // redirect to the search page
                window.location.href = "http://localhost:3000/searchResult.html?origin=" + originAirport + "&destination=" + destinationAirport + "&departureDate=" + departureDate + "&returnDate=" + returnDate + "&trip-type=" + type;
            }
        });
        $("#return-date").prop("disabled", true);
        $("#return-date").css("background-color", "lightgray");
        $("#return-date").attr("type", "text");
        $("#return-date").val("");
        $("input[name=trip-type]").change(function () {
            if ($(this).val() == "one_way") {
                $("#return-date").prop("disabled", true);
                $("#return-date").css("background-color", "lightgray");
                $("#return-date").attr("type", "text");
                $("#return-date").val("");
            } else {
                $("#return-date").prop("type", "date");
                $("#return-date").css("background-color", "white");
                $("#return-date").prop("disabled", false);
            }
        });
    });

</script>

</html>